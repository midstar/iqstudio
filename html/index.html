<html>
<meta charset="utf-8"/>
<head>
<title>IQ Data Studio</title>
<style>

canvas {
    border:1px solid #000000;
    margin-bottom: 5px;
}

#polar-canvas {
    cursor: crosshair;
}

.select-container, .notation-container {
    display: inline-block;
    vertical-align: top;
    border:1px solid lightgray;
    margin: 2px 0px 2px 0px;
    padding: 5px 5px 0px 5px;
}

.select-label {
    display: inline-block;
    width: 60px;
    text-align:center;
}

.notation-container {
    font-size: 10px;
}

#I_range, #Q_range {
    width: 100%;
}

#I_plot, #Q_plot {
    float: right;
}


</style>
</head>
<script>

//////////////////////////////////////////////////////////
// Globals
//////////////////////////////////////////////////////////

const DEG_TO_RAD = Math.PI / 180;

//////////////////////////////////////////////////////////
// Functions
//////////////////////////////////////////////////////////

window.onload = function() {
    updateDisplay();

    // Synchronize range and number inputs - I
    var I_range = document.getElementById("I_range");
    var I_number = document.getElementById("I_number");
    I_range.addEventListener('input', function (e) {
        I_set(e.target.value);
    });
    I_number.addEventListener('input', function (e) {
        I_set(e.target.value);
    });

    // Synchronize range and number inputs - Q
    var Q_range = document.getElementById("Q_range");
    var Q_number = document.getElementById("Q_number");
    Q_range.addEventListener('input', function (e) {
        Q_set(e.target.value);
    });
    Q_number.addEventListener('input', function (e) {
        Q_set(e.target.value);
    });

    // Synchronize range and number inputs - Mag
    var Mag_range = document.getElementById("Mag_range");
    var Mag_number = document.getElementById("Mag_number");
    Mag_range.addEventListener('input', function (e) {
        Mag_number.value = e.target.value;
        updateDisplay();
    });
    Mag_number.addEventListener('input', function (e) {
        Mag_range.value = e.target.value;
        updateDisplay();
    });

    // Synchronize range and number inputs - Ang
    var Ang_range = document.getElementById("Ang_range");
    var Ang_number = document.getElementById("Ang_number");
    Ang_range.addEventListener('input', function (e) {
        Ang_number.value = e.target.value;
        updateDisplay();
    });
    Ang_number.addEventListener('input', function (e) {
        Ang_range.value = e.target.value;
        updateDisplay();
    });

    // Handle click in the polar canvas
    configPolarCanvasEvents();
}

function updateDisplay() {
    var width = document.body.offsetWidth;
    var polar_canvas = document.getElementById("polar-canvas");
    var signal_canvas = document.getElementById("signal-canvas");
    signal_canvas.width = width - polar_canvas.width - 20;

    updateNotation();
    plotPolar("polar-canvas");
    plotSignals("signal-canvas");
}

function updateNotation() {
    var I_value = document.getElementById("I_number").value;
    var Q_value = document.getElementById("Q_number").value;
    var rect_notation = document.getElementById("rect-notation");
    var polar_notation = document.getElementById("polar-notation");

    if (Q_value >= 0) 
        rect_notation.innerHTML = I_value + " + " + Q_value + " i";
    else
        rect_notation.innerHTML = I_value + " - " + Math.abs(Q_value) + " i";
    
    var RF_amplitude = Math.round(Math.hypot(I_value, Q_value) * 100)/100;
    var RF_angle = Math.round(Math.atan(Q_value / I_value) * 100)/100;
    if (I_value < 0)
        RF_angle = Math.PI + RF_angle;
    else if (Q_value < 0)
        RF_angle = 2 * Math.PI + RF_angle;

    RF_angle = Math.round(RF_angle * 100)/100;

    polar_notation.innerHTML = RF_amplitude + ", " + RF_angle + " radians";

}

function plotPolar(canvasId) {
    var I_value = document.getElementById("I_number").value;
    var Q_value = document.getElementById("Q_number").value;

    var canvas = document.getElementById(canvasId);
    var ctx = canvas.getContext("2d");

    // Clear
    ctx.clearRect(0, 0, canvas.width, canvas.height);

    plotGrid(ctx, canvas.width, canvas.height, 10, true);

    var amplitudePx = (canvas.height / 2) / Math.sqrt(2);
    var centerX = canvas.width / 2;
    var centerY = canvas.height / 2;

    // Center circle and cross
    ctx.beginPath();
    ctx.arc(centerX, centerY, amplitudePx, 
            0, 2 * Math.PI);
    ctx.moveTo(centerX - amplitudePx * 1.1, centerY);
    ctx.lineTo(centerX + amplitudePx * 1.1, centerY);
    ctx.moveTo(centerX, centerY - amplitudePx * 1.1);
    ctx.lineTo(centerX, centerY + amplitudePx * 1.1);
    ctx.strokeStyle = "goldenrod";
    ctx.lineWidth = 2;
    ctx.stroke();

    // I/Q label
    ctx.font = "10px Arial";
    ctx.strokeStyle = "black";
    ctx.strokeText("I", amplitudePx * 1.2 + centerX, centerY + 4);
    ctx.strokeText("Q", centerX - 4, centerY - amplitudePx * 1.2);


    // I line
    ctx.beginPath();
    ctx.moveTo(centerX, 
               centerY - (Q_value * amplitudePx));
    ctx.lineTo(centerX + (I_value * amplitudePx), 
               centerY - (Q_value * amplitudePx));
    ctx.strokeStyle = "red";
    ctx.lineWidth = 2;
    ctx.stroke();

    // Q line
    ctx.beginPath();
    ctx.moveTo(centerX + (I_value * amplitudePx), 
               centerY);
    ctx.lineTo(centerX + (I_value * amplitudePx), 
               centerY - (Q_value * amplitudePx));
    ctx.strokeStyle = "blue";
    ctx.lineWidth = 2;
    ctx.stroke();  
    
    // RF line
    ctx.beginPath();
    ctx.moveTo(centerX, centerY);
    ctx.lineTo(centerX + (I_value * amplitudePx), 
               centerY - (Q_value * amplitudePx));
    ctx.strokeStyle = "green";
    ctx.lineWidth = 2;
    ctx.stroke();      

}

function plotSignals(canvasId) {
    var I_value = document.getElementById("I_number").value;
    var Q_value = document.getElementById("Q_number").value;
    var I_plot = document.getElementById("I_plot").checked;
    var Q_plot = document.getElementById("Q_plot").checked;
    var Carrier_plot = document.getElementById("Carrier_plot").checked;
    var RF_plot = document.getElementById("RF_plot").checked;

    var canvas = document.getElementById(canvasId);
    var ctx = canvas.getContext("2d");

    plotGrid(ctx, canvas.width, canvas.height, 10, false);

    var offsetPx = 5;
    var amplitudePx = (canvas.height / 2) / Math.sqrt(2);
    var periodPx = 100;
    var startY = canvas.height / 2;
    var endX = canvas.width - offsetPx;


    Carrier_func = function (angle) {
        return amplitudePx * Math.cos(angle * DEG_TO_RAD);
    };

    I_func = function (angle) {
        return I_value * amplitudePx * Math.cos(angle * DEG_TO_RAD);
    };

    Q_func = function (angle) {
        return Q_value * amplitudePx * Math.sin(angle * DEG_TO_RAD);
    };

    RF_func = function (angle) {
        return I_func(angle) + Q_func(angle);
    };

    if (Carrier_plot) {
        plotFunc(ctx, periodPx, startY, offsetPx, endX,
                "lightgreen", Carrier_func);
    }

    if (I_plot) {
        plotFunc(ctx, periodPx, startY, offsetPx, endX,
                "red", I_func);
    }

    if (Q_plot) {
        plotFunc(ctx, periodPx, startY, offsetPx, endX,
                "blue", Q_func);
    }

    if (RF_plot) {
        plotFunc(ctx, periodPx, startY, offsetPx, endX,
                "green", RF_func);
    }
}

function plotGrid(ctx, width, height, space, includeVertical) {
    ctx.strokeStyle = "lightgray";
    ctx.beginPath();

    // Horizontal lines
    var nbrHorLines = height / space - 1;
    for (var i = 1 ; i <= nbrHorLines ; i++) {
        ctx.moveTo(0, i * space);
        ctx.lineTo(width, i * space);
    }
 
    // Vertical lines lines
    var nbrVerLines = width / space - 1;
    for (var i = 1 ; i <= nbrVerLines ; i++) {
        ctx.moveTo(i * space, 0);
        ctx.lineTo(i * space, height);
    }

    ctx.lineWidth = 1;
    ctx.stroke();    


    // Horizontal Centre line (thicker)
    ctx.beginPath();
    ctx.moveTo(0, height / 2);
    ctx.lineTo(width, height / 2);
    ctx.lineWidth = 2;
    ctx.stroke(); 

    // Vertical Centre line (thicker)
    if (includeVertical) {
        ctx.beginPath();
        ctx.moveTo(width / 2, 0);
        ctx.lineTo(width / 2, height);
        ctx.lineWidth = 2;
        ctx.stroke();     
    }
}

function plotFunc(ctx, periodPx, startY, startX, endX,
                  color, func) {
    var angle = -1;
    var x = 0;
    var firstPoint = true;
    ctx.beginPath();
    while(x < endX) {
        angle++;
        y = func(angle) + startY;
        x = angle * periodPx / 360 + startX;
        if (firstPoint) {
            ctx.moveTo(x, y);
            firstPoint = false;
        }
        else {
            ctx.lineTo(x, y);
        }
    }
    ctx.strokeStyle = color;
    ctx.lineWidth = 2;
    ctx.stroke();
}

///////////////////////////////////////////////////////////////////////////////
// Misc calculations
///////////////////////////////////////////////////////////////////////////////

function round(value) {
    return Math.round(value * 100) / 100;
}

function I_set(I_value) {
    document.getElementById("I_number").value = I_value;
    document.getElementById("I_range").value = I_value;

    // Secure that Mag is <= 1 by if needed reduce Q
    var Q_value = document.getElementById("Q_number").value;
    if (Math.hypot(I_value, Q_value) > 1) {
        Q_value = round(Math.sqrt(1 - I_value * I_value) * Math.sign(Q_value));
        document.getElementById("Q_number").value = Q_value;
        document.getElementById("Q_range").value = Q_value;
    }

    updateDisplay();
}

function Q_set(Q_value) {
    document.getElementById("Q_number").value = Q_value;
    document.getElementById("Q_range").value = Q_value;

    // Secure that Mag is <= 1 by if needed reduce Q
    var I_value = document.getElementById("I_number").value;
    if (Math.hypot(I_value, Q_value) > 1) {
        I_value = round(Math.sqrt(1 - Q_value * Q_value) * Math.sign(I_value));
        document.getElementById("I_number").value = I_value;
        document.getElementById("I_range").value = I_value;
    }

    updateDisplay();
}


///////////////////////////////////////////////////////////////////////////////
// Selecting I/Q on the polar plot
///////////////////////////////////////////////////////////////////////////////

var mouseDown = false;

function configPolarCanvasEvents() {
    var polar_canvas = document.getElementById("polar-canvas");
    polar_canvas.addEventListener('mouseup', function (e) {
        mouseDown = false;
    });
    polar_canvas.addEventListener('mousedown', function (e) {
        mouseDown = true;
        polarXYtoIQ(event.offsetX, event.offsetY);
    });
    polar_canvas.addEventListener('mousemove', function (e) {
        if (mouseDown)
            polarXYtoIQ(event.offsetX, event.offsetY);
    });
}

function polarXYtoIQ(x, y) {
    var polar_canvas = document.getElementById("polar-canvas");
    var I_range = document.getElementById("I_range");
    var I_number = document.getElementById("I_number");
    var Q_range = document.getElementById("Q_range");
    var Q_number = document.getElementById("Q_number");

    var amplitudePx = (polar_canvas.height / 2) / Math.sqrt(2);
    var centerX = polar_canvas.width / 2;
    var centerY = polar_canvas.height / 2;


    var I_value = (x - centerX) / amplitudePx;
    I_value = Math.round(I_value * 100) / 100;
    I_value = Math.min(I_value, 1);
    I_value = Math.max(I_value, -1);

    var Q_value = (centerY - y) / amplitudePx;
    Q_value = Math.round(Q_value * 100) / 100;
    Q_value = Math.min(Q_value, 1);
    Q_value = Math.max(Q_value, -1);

    I_number.value = I_value;
    I_range.value  = I_value;

    Q_number.value = Q_value;
    Q_range.value  = Q_value;

    updateDisplay();
}

</script>

<body onresize="updateDisplay()">

    <div class="select-container">
        <div class="select-label"><b style="color:red">I</b></div>
        <input id="I_number" type="number" id="quantity" name="quantity" min="-1" max="1" value="1" step="0.01" size="4">
        <input id="I_plot" type="checkbox" checked onchange="updateDisplay()">
        <br>
        <input id="I_range" type="range" min="-1" max="1" value="1" step="0.01">
    </div>
    <div class="select-container">
        <div class="select-label"><b style="color:blue">Q</b></div>
        <input id="Q_number" type="number" id="quantity" name="quantity" min="-1" max="1" value="0" step="0.01" size="4">
        <input id="Q_plot" type="checkbox" checked onchange="updateDisplay()">
        <br>
        <input id="Q_range" type="range" min="-1" max="1" value="0" step="0.01">
    </div>
    <div class="select-container">
        <div class="select-label"><b style="color:green">Mag</b></div>
        <input id="Mag_number" type="number" id="quantity" name="quantity" min="0" max="1" value="0" step="0.01" size="4">
        <br>
        <input id="Mag_range" type="range" min="0" max="1" value="1" step="0.01">
    </div>
    <div class="select-container">
        <div class="select-label"><b style="color:goldenrod">Ang</b></div>
        <input id="Ang_number" type="number" id="quantity" name="quantity" min="0" max="360" value="0" step="0.01" size="4">
        <br>
        <input id="Ang_range" type="range" min="0" max="360" value="1" step="0.1">
    </div>
    <div class="select-container">
        <div class="select-label"><b style="color:lightgreen">Carrier</b></div>
        <input id="Carrier_plot" type="checkbox" checked onchange="updateDisplay()">
        <br>
        <div class="select-label"><b style="color:green">RF</b></div>
        <input id="RF_plot" type="checkbox" checked onchange="updateDisplay()">
    </div>
    <div class="notation-container">
        <div><b>Rectangular notation:</b></div>
        <div id="rect-notation">0.45 + 0.66 * i</div>
    </div>
    <div class="notation-container">
        <div><b>Polar notation:</b></div>
        <div id="polar-notation">0.45, 2.3 radians</div>
    </div>
    <br>
    <canvas id="polar-canvas" height="200" width="200"></canvas>
    <canvas id="signal-canvas" height="200"></canvas>

</body>
</html>